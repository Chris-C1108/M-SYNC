# M-SYNC 消息代理服务开发计划

## 项目概述

**消息代理服务 (MessageBrokerService)** 是 M-SYNC 系统的核心组件，负责：
- 接收来自所有客户端类型的消息发布请求
- 管理统一访问令牌认证和授权
- 维护 WebSocket 连接池
- 实时分发消息到桌面客户端
- 提供完整的Token管理功能

## 开发阶段规划

### Phase 1: 基础架构搭建 ✅
**目标**: 建立项目基础结构和核心框架
**预计时间**: 2-3天

#### 已完成任务:
- [x] 项目目录结构创建
- [x] package.json 配置和依赖管理
- [x] 环境配置文件 (.env, config/)
- [x] 基础应用入口 (app.js)
- [x] 日志系统 (logger.js)
- [x] 路由框架 (routes/)
- [x] 控制器框架 (controllers/)
- [x] 中间件框架 (middleware/)
- [x] 数据库连接和迁移系统
- [x] 统一Token认证架构设计

#### 已完成任务:
- [x] WebSocket 服务框架
- [x] 消息广播机制

### Phase 2: 统一Token认证系统 ✅
**目标**: 实现统一访问令牌认证机制
**预计时间**: 3-4天

#### 已完成任务:
- [x] **数据库连接模块** (`src/database/connection.js`)
  - SQLite 连接配置
  - PostgreSQL 连接支持
  - 连接池管理
  - 健康检查

- [x] **用户模型** (`src/models/User.js`)
  - 用户表结构定义
  - CRUD 操作方法
  - 密码加密处理

- [x] **访问令牌模型** (`src/models/AccessToken.js`)
  - 统一Token表结构定义
  - Token生成和验证
  - 设备信息管理
  - 权限控制

- [x] **消息模型** (`src/models/Message.js`)
  - 消息表结构定义
  - 消息类型枚举
  - 历史记录查询
  - 统计信息计算

- [x] **数据库迁移** (`src/database/migrations/`)
  - 用户表结构
  - 访问令牌表结构
  - 消息表结构
  - 索引创建

#### 验收标准:
- 数据库连接正常 ✅
- 统一Token认证功能 ✅
- 用户注册/登录功能 ✅
- 消息存储和查询功能 ✅

### Phase 3: Token管理API实现 ✅
**目标**: 实现Token管理和用户认证API
**预计时间**: 2-3天

#### 已完成任务:
- [x] **认证服务** (`src/services/AuthenticationService.js`)
  - 用户注册逻辑
  - 登录验证
  - 统一Token生成和验证
  - Token管理功能

- [x] **Token管理控制器** (`src/controllers/TokenController.js`)
  - Token创建、查看、更新、撤销
  - 批量Token管理
  - 当前Token信息获取

- [x] **统一认证中间件** (`src/middleware/auth.js`)
  - 统一Token认证逻辑
  - 权限检查机制
  - 灵活的Token传输方式

- [x] **验证工具** (`src/utils/validator.js`)
  - Joi 验证模式定义
  - Token相关验证
  - 请求数据验证

#### 验收标准:
- 用户注册/登录 API 正常工作 ✅
- 统一Token认证机制完善 ✅
- Token管理API功能完整 ✅
- 安全性测试通过 ✅

### Phase 4: 消息代理核心服务
**目标**: 实现消息发布和路由核心逻辑
**预计时间**: 4-5天

#### 核心任务:
- [ ] **消息代理服务** (`src/services/MessageBrokerService.js`)
  - 消息发布逻辑
  - 消息验证和处理
  - 用户消息路由
  - 消息历史管理
  - 统计信息计算

- [ ] **消息验证器** (`src/services/MessageValidator.js`)
  - 消息格式验证
  - 内容安全检查
  - 消息类型处理
  - 大小限制检查

- [ ] **连接池管理器** (`src/services/ConnectionPoolManager.js`)
  - WebSocket 连接管理
  - 用户连接映射
  - 连接状态监控
  - 心跳检测机制

#### 验收标准:
- 消息发布 API 正常工作
- 消息验证机制完善
- 连接池管理稳定
- 性能测试通过

### Phase 5: WebSocket 实时服务 ✅
**目标**: 实现实时消息分发功能
**预计时间**: 3-4天

#### 已完成任务:
- [x] **WebSocket服务** (`src/services/WebSocketService.js`)
  - WebSocket 服务器设置
  - 连接建立和认证
  - 消息广播逻辑
  - 连接状态管理

- [x] **消息代理服务** (`src/services/MessageBrokerService.js`)
  - 连接生命周期管理
  - 用户连接映射
  - 连接池维护
  - 异常连接处理

- [x] **心跳检测机制**
  - WebSocket 消息处理
  - 心跳包处理
  - 错误消息处理
  - 连接状态同步

#### 验收标准:
- WebSocket 连接建立正常 ✅
- 消息实时分发功能正常 ✅
- 心跳机制稳定 ✅
- 并发连接测试通过 ✅

### Phase 6: 工具和配置完善
**目标**: 完善开发和部署工具
**预计时间**: 2-3天

#### 核心任务:
- [ ] **工具函数完善** (`src/utils/`)
  - 加密工具 (`crypto.js`)
  - 验证工具完善 (`validator.js`)
  - 系统信息工具

- [ ] **配置管理完善** (`src/config/`)
  - 数据库配置 (`database.js`)
  - Redis 配置 (`redis.js`)
  - 应用配置 (`app.js`)

- [ ] **部署脚本**
  - Docker 配置
  - 环境变量管理
  - 健康检查脚本

#### 验收标准:
- 所有工具函数正常工作
- 配置管理灵活可靠
- 部署流程自动化

### Phase 7: 测试和优化
**目标**: 完善测试覆盖和性能优化
**预计时间**: 3-4天

#### 核心任务:
- [ ] **单元测试** (`tests/unit/`)
  - 服务类测试
  - 工具函数测试
  - 模型测试
  - 中间件测试

- [ ] **集成测试** (`tests/integration/`)
  - API 接口测试
  - WebSocket 连接测试
  - 数据库操作测试
  - 认证流程测试

- [ ] **性能优化**
  - 数据库查询优化
  - 内存使用优化
  - 并发处理优化
  - 缓存策略实现

#### 验收标准:
- 测试覆盖率 > 90%
- 所有测试用例通过
- 性能指标达标
- 代码质量检查通过

## 技术要求

### 性能指标
- **消息延迟**: < 100ms (端到端)
- **并发连接**: 支持 1000+ WebSocket 连接
- **消息吞吐**: 1000+ 消息/秒
- **内存占用**: < 100MB (基础配置)

### 代码质量
- **测试覆盖率**: > 90%
- **ESLint**: 无警告和错误
- **文档完整性**: 所有公共 API 有文档
- **错误处理**: 完善的错误处理和日志记录

### 安全要求
- **认证机制**: JWT + API Token 双重认证
- **数据验证**: 所有输入数据验证
- **SQL 注入防护**: 使用参数化查询
- **XSS 防护**: 输入输出过滤

## 开发规范

### 代码风格
- 使用 ESLint Standard 配置
- 函数和变量使用 camelCase
- 类名使用 PascalCase
- 常量使用 UPPER_SNAKE_CASE

### 提交规范
```
type(scope): description

feat(auth): add JWT token refresh mechanism
fix(websocket): resolve connection pool memory leak
docs(api): update message publish endpoint documentation
test(integration): add websocket connection tests
```

### 分支策略
- `main`: 生产环境代码
- `develop`: 开发环境代码
- `feature/{feature-name}`: 功能开发分支
- `fix/{bug-description}`: 问题修复分支

## 部署计划

### 开发环境
- SQLite 数据库
- 本地 Redis (可选)
- 开发模式日志
- 热重载支持

### 生产环境
- PostgreSQL 数据库
- Redis 缓存
- PM2 进程管理
- Nginx 反向代理
- Docker 容器化部署

## 风险评估

### 技术风险
- **WebSocket 连接稳定性**: 实现重连机制和心跳检测
- **数据库性能**: 优化查询和索引设计
- **内存泄漏**: 定期监控和测试

### 业务风险
- **消息丢失**: 实现消息确认和重试机制
- **安全漏洞**: 定期安全审计和更新
- **扩展性限制**: 设计支持水平扩展的架构

这个开发计划确保了 M-SYNC 消息代理服务的高质量交付，涵盖了从基础架构到生产部署的完整流程。
